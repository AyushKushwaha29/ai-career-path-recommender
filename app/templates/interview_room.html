{% extends "base.html" %}
{% block content %}
<div class="container py-3">
    <div class="glass-card p-0 overflow-hidden" style="height: 80vh; display: flex; flex-direction: column;">
        
        <div class="p-3 bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Interviewing for: <strong>{{ session.role }}</strong></h5>
            <a href="/interview" class="btn btn-sm btn-outline-light">End Session</a>
        </div>

        <div id="chat-box" class="p-4" style="flex: 1; overflow-y: auto; background: rgba(255,255,255,0.5);">
            {% for msg in session.messages %}
                <div class="d-flex {{ 'justify-content-end' if msg.sender == 'User' else 'justify-content-start' }} mb-3">
                    <div class="p-3 rounded-3 shadow-sm" 
                         style="max-width: 75%; 
                                background: {{ 'var(--primary-color)' if msg.sender == 'User' else '#fff' }}; 
                                color: {{ '#fff' if msg.sender == 'User' else '#333' }};">
                        <strong>{{ msg.sender }}:</strong> {{ msg.content }}
                    </div>
                </div>
            {% endfor %}
        </div>

        <div class="p-3 bg-light border-top">
            <div class="input-group">
                <input type="text" id="user-input" class="form-control" placeholder="Type your answer...">
                <button class="btn btn-primary" onclick="sendMessage()">Send âž¤</button>
            </div>
        </div>
    </div>
</div>

<script>
const sessionId = {{ session.id }};
const chatBox = document.getElementById('chat-box');
const userInput = document.getElementById('user-input');

// Scroll to bottom on load
chatBox.scrollTop = chatBox.scrollHeight;

// Handle Enter Key
userInput.addEventListener('keypress', function (e) {
    if (e.key === 'Enter') sendMessage();
});

async function sendMessage() {
    const text = userInput.value.trim();
    if (!text) return;

    // 1. Add User Message to UI
    appendMessage('User', text);
    userInput.value = '';

    // 2. Send to Backend
    try {
        const res = await fetch('/interview/chat', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ session_id: sessionId, message: text })
        });
        const data = await res.json();
        
        // 3. Add AI Response to UI
        appendMessage('AI', data.message);
    } catch (err) {
        console.error("Error:", err);
    }
}

function appendMessage(sender, text) {
    const div = document.createElement('div');
    div.className = `d-flex ${sender === 'User' ? 'justify-content-end' : 'justify-content-start'} mb-3`;
    
    const bubble = document.createElement('div');
    bubble.className = "p-3 rounded-3 shadow-sm";
    bubble.style.maxWidth = "75%";
    
    if (sender === 'User') {
        bubble.style.background = "#0d6efd"; // Bootstrap Primary
        bubble.style.color = "#fff";
    } else {
        bubble.style.background = "#fff";
        bubble.style.color = "#333";
    }

    bubble.innerHTML = `<strong>${sender}:</strong> ${text}`;
    div.appendChild(bubble);
    chatBox.appendChild(div);
    
    // Auto Scroll
    chatBox.scrollTop = chatBox.scrollHeight;
}
</script>
{% endblock %}